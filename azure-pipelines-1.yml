trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'

- script: |
    python -m pip install --upgrade pip
    python -m pip install selenium==4.12.0
    python -m pip install pytest
    python -m pip install pytest-html
    python -m pip install pytest-xdist
    python -m pip install pytest-nunit
    python -m pip install pytest-cov
    python -m pip install -r requirements.txt
  displayName: 'Install dependencies and plugins'

- script: |
    python -m pip list
  displayName: 'Check installed Python packages'

# ðŸš€ ADDED: Run Unit Tests + Coverage
- script: |
    pytest tests/test_unit.py -rA --cov=form_webapp --cov-report=html:coverage_report --cov-report=xml:coverage.xml
  displayName: 'Run Unit Tests with Coverage'

- script: |
    pytest -rA --html=reports/Report.html --self-contained-html --doctest-modules --nunitxml=nunit/test-results.xml -n 5
  displayName: 'Run Selenium Tests and Generate Reports'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'NUnit'
    testResultsFiles: 'nunit/test-results.xml'
    failTaskOnFailedTests: true
    testRunTitle: 'Publish NUnit Test Results'
  displayName: 'Publish NUnit Test Results'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'reports/Report.html'
    ArtifactName: 'TestReports'
    publishLocation: 'Container'
  displayName: 'Publish Pytest HTML Report'

# ðŸš€ ADDED: Publish Coverage Report as Artifact
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'coverage_report/Coverage_report.html'
    ArtifactName: 'CoverageReport'
    publishLocation: 'Container'
  displayName: 'Publish Coverage HTML Report'
