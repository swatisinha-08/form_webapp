trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'

- script: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
    pip install coverage
  displayName: 'Install dependencies'

- script: |
    python -m pip list
  displayName: 'Check installed Python packages'

# Run UNIT TESTS with coverage
- script: |
    coverage run -m pytest tests/test_unit.py
    coverage report
    coverage html -d htmlcov
  displayName: 'Run Unit Tests with Coverage'

# Run SELENIUM TESTS
- script: |
    pytest tests/test_selenium.py -rA --html=reports/SeleniumReport.html --self-contained-html --nunitxml=nunit/selenium-test-results.xml -n 2
  displayName: 'Run Selenium Tests and Generate Reports'

# Publish Unit Test Coverage Report
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'htmlcov'
    ArtifactName: 'CoverageReport'
    publishLocation: 'Container'
  displayName: 'Publish Coverage Report'

# Publish Selenium HTML Report
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'reports/SeleniumReport.html'
    ArtifactName: 'SeleniumReports'
    publishLocation: 'Container'
  displayName: 'Publish Selenium HTML Report'

# Publish NUnit Results for Selenium
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'NUnit'
    testResultsFiles: 'nunit/selenium-test-results.xml'
    failTaskOnFailedTests: true
    testRunTitle: 'Publish Selenium NUnit Test Results'
  displayName: 'Publish NUnit Test Results'
